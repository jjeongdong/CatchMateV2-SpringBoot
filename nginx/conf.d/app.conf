map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    server_name 15.165.203.157;

    resolver 127.0.0.11 valid=30s;

    include /etc/nginx/conf.d/service-env.inc;

    # SSL ì¸ì¦ì„œ ë°œê¸‰ì„ ìœ„í•œ ì„¤ì • (Certbotìš©)
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # WebSocket ì—°ê²°ì„ ìœ„í•œ ì„¤ì •
    location /ws/ {
        proxy_pass $service_url;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket íƒ€ì„ì•„ì›ƒ ì„¤ì • (ê¸°ë³¸ 60ì´ˆ -> ë” ê¸¸ê²Œ)
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    location / {
        proxy_pass $service_url;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ğŸ‘‡ [ì¶”ê°€ ì„¤ì •] 150 TPS ì´ìƒ ëŒ€ê·œëª¨ íŠ¸ë˜í”½ ë°©ì–´ìš© ğŸ‘‡
        proxy_http_version 1.1;
        proxy_set_header Connection ""; # Keep-Alive í™œì„±í™”ë¡œ ì—°ê²° ì¬ì‚¬ìš©

        # Nginx <-> Spring Boot ê°„ íƒ€ì„ì•„ì›ƒ ë„‰ë„‰í•˜ê²Œ ì—°ì¥
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # ë°€ë ¤ì˜¤ëŠ” ì‘ë‹µì„ ë‹´ì•„ë‘˜ ë²„í¼(ë©”ëª¨ë¦¬) í¬ê¸° í™•ì¥
        proxy_buffer_size 16k;
        proxy_buffers 4 32k;
    }
}
